name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ” Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: ğŸ”§ Setup SSH with password
      run: |
        # Instalar sshpass para autenticaÃ§Ã£o por senha
        sudo apt-get update
        sudo apt-get install -y sshpass
        
    - name: ğŸ§¹ Clean cache
      run: |
        npm cache clean --force
        rm -rf node_modules package-lock.json
        
    - name: ğŸ“¦ Install dependencies (Frontend)
      run: |
        npm install --verbose
        npm list --depth=0
        
    - name: ğŸ“¦ Install dependencies (Backend)
      run: |
        cd backend
        npm install --verbose
        npm list --depth=0
        cd ..
        
    - name: ğŸ”¨ Build Frontend
      run: |
        echo "ğŸ”¨ Iniciando build do frontend..."
        npm run build
        echo "âœ… Build do frontend concluÃ­do!"
        ls -la dist/
        
    - name: ğŸ”¨ Build Backend
      run: |
        echo "ğŸ”¨ Iniciando build do backend..."
        cd backend
        npm run build
        echo "âœ… Build do backend concluÃ­do!"
        ls -la dist/
        cd ..
        
    - name: ğŸ“¤ Deploy to server (Clean Install)
      run: |
        # Criar arquivo de deploy temporÃ¡rio
        cat > deploy-remote.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ Iniciando deploy limpo..."
        
        # Navegar para o diretÃ³rio do projeto
        cd /var/www/sistema_raunaimer
        
        # Parar e remover todas as aplicaÃ§Ãµes PM2
        echo "ğŸ›‘ Parando todas as aplicaÃ§Ãµes..."
        pm2 stop all 2>/dev/null || true
        pm2 delete all 2>/dev/null || true
        
        # Fazer pull das mudanÃ§as
        echo "ğŸ“¥ Fazendo pull das mudanÃ§as..."
        git fetch origin main
        git reset --hard origin/main
        
        # Limpar cache e node_modules
        echo "ğŸ§¹ Limpando cache..."
        rm -rf node_modules package-lock.json
        rm -rf backend/node_modules backend/package-lock.json
        
        # Configurar permissÃµes
        chown -R deploy:deploy /var/www/sistema_raunaimer
        
        # Instalar dependÃªncias
        echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
        npm install
        
        echo "ğŸ“¦ Instalando dependÃªncias do backend..."
        cd backend && npm install && cd ..
        
        # Build das aplicaÃ§Ãµes
        echo "ğŸ”¨ Build do frontend..."
        npm run build
        
        echo "ğŸ”¨ Build do backend..."
        cd backend && npm run build && cd ..
        
        # Iniciar com PM2
        echo "ğŸš€ Iniciando aplicaÃ§Ãµes com PM2..."
        pm2 start ecosystem.config.cjs --env production
        
        # Salvar configuraÃ§Ã£o
        pm2 save
        
        # Verificar status
        echo "âœ… Deploy limpo concluÃ­do com sucesso!"
        pm2 status
        
        # Mostrar logs recentes
        echo "ğŸ“‹ Logs recentes do backend:"
        pm2 logs raunaimer-backend --lines 10 --nostream || true
        
        echo "ğŸ“‹ Logs recentes do frontend:"
        pm2 logs raunaimer-frontend --lines 5 --nostream || true
        
        echo "ğŸŒ URLs das aplicaÃ§Ãµes:"
        echo "Frontend: http://app.raunaimer.adv.br"
        echo "Backend: http://app.raunaimer.adv.br/api"
        EOF
        
        # Copiar arquivo para o servidor usando sshpass
        sshpass -p '${{ secrets.SSH_PASSWORD }}' scp -o StrictHostKeyChecking=no deploy-remote.sh root@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Executar deploy no servidor usando sshpass
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
        chmod +x /tmp/deploy-remote.sh
        /tmp/deploy-remote.sh
        rm /tmp/deploy-remote.sh
        EOF
        
    - name: ğŸ”§ Verificar e corrigir serviÃ§os
      run: |
        # Script de verificaÃ§Ã£o e correÃ§Ã£o
        cat > check-services.sh << 'EOF'
        #!/bin/bash
        echo "ğŸ” Verificando status dos serviÃ§os..."
        
        # Verificar se PM2 estÃ¡ rodando
        if ! pm2 list | grep -q "raunaimer"; then
          echo "âŒ PM2 nÃ£o estÃ¡ rodando, reiniciando..."
          cd /var/www/sistema_raunaimer
          pm2 start ecosystem.config.cjs --env production
          pm2 save
        fi
        
        # Verificar se backend estÃ¡ respondendo
        echo "ğŸ” Testando backend na porta 3001..."
        if curl -f http://localhost:3001/api/condominio > /dev/null 2>&1; then
          echo "âœ… Backend estÃ¡ respondendo"
        else
          echo "âŒ Backend nÃ£o estÃ¡ respondendo, reiniciando..."
          pm2 restart raunaimer-backend
          sleep 5
          if curl -f http://localhost:3001/api/condominio > /dev/null 2>&1; then
            echo "âœ… Backend reiniciado com sucesso"
          else
            echo "âŒ Backend ainda nÃ£o estÃ¡ respondendo"
            pm2 logs raunaimer-backend --lines 20
          fi
        fi
        
        # Verificar se frontend estÃ¡ respondendo
        echo "ğŸ” Testando frontend na porta 3000..."
        if curl -f http://localhost:3000 > /dev/null 2>&1; then
          echo "âœ… Frontend estÃ¡ respondendo"
        else
          echo "âŒ Frontend nÃ£o estÃ¡ respondendo, reiniciando..."
          pm2 restart raunaimer-frontend
        fi
        
        # Verificar Nginx
        echo "ğŸ” Verificando Nginx..."
        if systemctl is-active --quiet nginx; then
          echo "âœ… Nginx estÃ¡ ativo"
        else
          echo "âŒ Nginx nÃ£o estÃ¡ ativo, reiniciando..."
          systemctl restart nginx
        fi
        
        # Status final
        echo "ğŸ“Š Status final dos serviÃ§os:"
        pm2 status
        echo "ğŸŒ Testando aplicaÃ§Ã£o:"
        curl -I http://app.raunaimer.adv.br || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ acessÃ­vel"
        EOF
        
        # Executar verificaÃ§Ã£o
        sshpass -p '${{ secrets.SSH_PASSWORD }}' scp -o StrictHostKeyChecking=no check-services.sh root@${{ secrets.SERVER_HOST }}:/tmp/
        sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
        chmod +x /tmp/check-services.sh
        /tmp/check-services.sh
        rm /tmp/check-services.sh
        EOF
        
    - name: âœ… Deploy completed
      run: echo "Deploy limpo concluÃ­do com sucesso!" 