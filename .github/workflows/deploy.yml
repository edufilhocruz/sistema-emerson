name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Checkout code
      uses: actions/checkout@v4
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies (Frontend)
      run: |
        npm install
        
    - name: üì¶ Install dependencies (Backend)
      run: |
        cd backend
        npm install
        cd ..
        
    - name: üî® Build Frontend
      run: |
        npm run build
        
    - name: üî® Build Backend
      run: |
        cd backend
        npm run build
        cd ..
        
    - name: üì§ Deploy to server
      run: |
        # Instalar sshpass
        sudo apt-get update
        sudo apt-get install -y sshpass
        
        # Configurar SSH
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # Executar deploy no servidor
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        cd /var/www/sistema_raunaimer
        
        # Parar aplica√ß√µes
        pm2 stop all 2>/dev/null || true
        pm2 delete all 2>/dev/null || true
        
        # Fazer pull das mudan√ßas
        git fetch origin main
        git reset --hard origin/main
        
        # Limpar cache
        rm -rf node_modules package-lock.json
        rm -rf backend/node_modules backend/package-lock.json
        
        # Instalar depend√™ncias
        npm install
        cd backend && npm install && cd ..
        
        # Build
        npm run build
        cd backend && npm run build && cd ..
        
        # Criar logs
        mkdir -p logs
        
        # Iniciar PM2
        pm2 start ecosystem.config.cjs --env production
        pm2 save
        
        # Verificar status
        pm2 status
        EOF
        
    - name: ‚úÖ Deploy completed
      run: |
        echo "üöÄ Deploy conclu√≠do com sucesso!"
        echo "üåê Aplica√ß√£o dispon√≠vel em: http://app.raunaimer.adv.br" 